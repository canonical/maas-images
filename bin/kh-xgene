#!/bin/bash

XGENE_KERNEL_MAX_SIZE="16777152"

cleanup() { [ -n "$TEMP_D" ] && rm -Rf "${TEMP_D}"; }
error() { echo "$@" 1>&2; }
fail() { [ $# -eq 0 ] || error "$@"; exit 1; }

compress_type() {
    local file="$1"
    magic="$(od -x -N2 $file | head -1 | cut -d' ' -f2)"
    case $magic in
        8b1f)
            echo "gzip"
            ;;
        *)
            echo "none"
            ;;
    esac
}

TEMP_D=$(mktemp -d "${0##*/}.XXXXXX") &&
	trap cleanup EXIT || exit 1

kernel="$1"
initrd="$2"
info=${VERSION_FLAVOR:-"unknown-ver unknown-flavor"}

if [ "$(compress_type $kernel)" = "none" ]; then
    # Compress to increase odds of remaining under $XGENE_KERNEL_MAX_SIZE
    # LP: #1954692
    gzip -9 < "$kernel" > "${TEMP_D}/kernel" ||
	fail "failed to gzip '$kernel'"
else
    cp "$kernel" "${TEMP_D}/kernel" ||
	fail "failed copy kernel '$kernel'"
fi
cp "$initrd" "${TEMP_D}/initrd" ||
	fail "failed copy initrd '$initrd'"

[ "$(stat -c '%s' "${TEMP_D}/kernel")" -le "$XGENE_KERNEL_MAX_SIZE" ] ||
    fail "kernel is larger than \$XGENE_KERNEL_MAX_SIZE"

comp="$(compress_type ${TEMP_D}/kernel)"
mkimage -A arm -O linux -T kernel  -C $comp -a 0x80000 -e 0x80000 \
    -n "kernel $info" -d "${TEMP_D}/kernel" "$kernel" ||
	fail "failed mkimage for kernel";
comp="$(compress_type ${TEMP_D}/initrd)"
mkimage -A arm -O linux -T ramdisk -C $comp -a 0x0     -e 0x0 \
    -n "ramdisk $info" -d "${TEMP_D}/initrd" "$initrd" ||
	fail "failed mkimage for initrd";
