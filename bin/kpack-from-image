#!/bin/bash

TEMP_D=""
img="$1"
kpkg="$2"
flags="$3"   # flags here is subarch (explicitly for xgene-uboot)
kern_out=${4:-kernel}
initrd_out=${5:-initrd}

cleanup() { [ -n "$TEMP_D" ] && rm -Rf "${TEMP_D}"; }
error() { echo "$@" 1>&2; }
fail() { [ $# -eq 0 ] || error "$@"; exit 1; }

TEMP_D=$(mktemp -d "${TMPDIR:-/tmp}/${0##*/}.XXXXXX")
trap cleanup EXIT

myimg="${TEMP_D}/my.img"
cp --sparse=always "$img" "$myimg" || error "failed cp $img"

gid=$(id -g)
uid=$(id -u)
chown_to="$gid:$uid"

sudo "KPACK_SKIP_APT_UPDATE=${KPACK_SKIP_APT_UPDATE:-false}" \
   "http_proxy=$http_proxy" LANG=C PACKAGES="$kpkg" \
   FLASH_KERNEL_SKIP=1 \
   chown_to="$chown_to" "kout=${kern_out}" "iout=${initrd_out}" \
   flags="$flags" \
   mount-image-callback --sys --proc \
      --system-resolvconf "$myimg" -- sh <<"ENDCALLBACK"
set -e
DEBIAN_FRONTEND=noninteractive \
  chroot "$MOUNTPOINT" /bin/sh -ec '
    kpkg="$1"
    ${KPACK_SKIP_APT_UPDATE} || apt-get update -q
    zzgrub=/etc/kernel/postinst.d/zz-update-grub

    copymods="cloud-initramfs-copymods"
    apt-cache show $copymods >/dev/null 2>&1 ||
      { echo "copymods not available"; copymods=""; }
    [ ! -x "$zzgrub" ] || chmod ugo-x $zzgrub
    which eatmydata >/dev/null 2>&1 && emd=eatmydata || emd=""
    $emd apt-get install --assume-yes --quiet $copymods "$@"

    kernel=""
    for f in /boot/vmlin*; do
        [ -f "$f" ] || continue
        out=$(dpkg -S "$f")
        pkg=${out%%:*}
        [ "$pkg" = "$kpkg" ] && kernel="$f" && break
        if apt-get --dry-run remove $pkg | grep "Remv $kpkg "; then
            kernel="$f"
            break
        fi
    done
    [ -z "$kernel" ] && { echo "no kernel found!" 1>&2; exit 1; }
    verflav=${kernel#/boot/*-}
    initrd="/boot/initrd.img-$verflav"
    [ -f "$initrd" ] || { echo "no initrd for $verflav" 1>&2; exit 1; }
    chmod ugo+r "$kernel" "$initrd"
    cp "$kernel" /tmp/kernel
    cp "$initrd" /tmp/initrd
    echo "$verflav" > /tmp/verflav
  ' -- $PACKAGES </dev/null

if [ "$flags" = "xgene-uboot" ]; then
    read verflav < "$MOUNTPOINT/tmp/verflav"
    kpath="$MOUNTPOINT/tmp/kernel"
    ipath="$MOUNTPOINT/tmp/initrd"
    mv "$kpath" "$kpath.orig"
    mv "$ipath" "$ipath.orig"
    echo "generating uboot kernel and initramfs for xgene"
    set -x
    mkimage -A arm -O linux -T kernel  -C none -a 0x80000 -e 0x80000 \
        -n "kernel $verflav" -d "$kpath.orig" "$kpath"
    mkimage -A arm -O linux -T ramdisk -C gzip -a 0x0     -e 0x0 \
        -n "ramdisk $verflav" -d "$ipath.orig" "$ipath"
    set +x
fi
chown "$chown_to" "$MOUNTPOINT/tmp/kernel"
chown "$chown_to" "$MOUNTPOINT/tmp/initrd"
mv "$MOUNTPOINT/tmp/kernel" "$kout"
mv "$MOUNTPOINT/tmp/initrd" "$iout"
ENDCALLBACK
ret=$?
[ $ret -eq 0 ] || exit $ret

error "wrote to ${kern_out}, ${initrd_out}"
