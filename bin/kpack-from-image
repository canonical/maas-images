#!/bin/bash

TEMP_D=""
img="$1"
kpkg="$2"
kern_out=${3:-kernel}
initrd_out=${4:-initrd}

cleanup() { [ -n "$TEMP_D" ] && rm -Rf "${TEMP_D}"; }
error() { echo "$@" 1>&2; }
fail() { [ $# -eq 0 ] || error "$@"; exit 1; }

TEMP_D=$(mktemp -d "${TMPDIR:-/tmp}/${0##*/}.XXXXXX")
trap cleanup EXIT

myimg="${TEMP_D}/my.img"
cp --sparse=always "$img" "$myimg" || error "failed cp $img"

gid=$(id -g)
uid=$(id -u)
chown_to="$gid:$uid"

sudo "KPACK_SKIP_APT_UPDATE=${KPACK_SKIP_APT_UPDATE:-false}" \
   "http_proxy=$http_proxy" LANG=C PACKAGES="$kpkg" \
   chown_to="$chown_to" "kout=${kern_out}" "iout=${initrd_out}" \
   mount-image-callback --sys --proc \
      --system-resolvconf "$myimg" -- sh <<"ENDCALLBACK"
set -e
DEBIAN_FRONTEND=noninteractive \
  chroot "$MOUNTPOINT" /bin/sh -ec '
    rm -f /boot/vmlin* /boot/initrd*
    ${KPACK_SKIP_APT_UPDATE} || apt-get update -q
    zzgrub=/etc/kernel/postinst.d/zz-update-grub

    copymods="cloud-initramfs-copymods"
    apt-cache show $copymods >/dev/null 2>&1 ||
      { echo "copymods not available"; copymods=""; }
    [ ! -x "$zzgrub" ] || chmod ugo-x $zzgrub
    which eatmydata >/dev/null 2>&1 && emd=eatmydata || emd=""
    $emd apt-get install --assume-yes --quiet $copymods "$@"
    chmod ugo+r /boot/*
  ' -- $PACKAGES </dev/null
chown "$chown_to" "$MOUNTPOINT/boot/initr"*
chown "$chown_to" "$MOUNTPOINT/boot/vmlin"*
mv "$MOUNTPOINT/boot/vmlin"* "$kout"
mv "$MOUNTPOINT/boot/initrd"* "$iout"
chmod ugo+r "$kout" "$iout"
ENDCALLBACK

error "wrote to ${kern_out}, ${initrd_out}"
