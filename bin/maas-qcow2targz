#!/bin/bash -e
#
# maas-qcowtargz - Take a qcow2 or qcow2.xz file from a given URL or
#                  file path and make it sufficient for use as a 
#                  MAAS installable image
#
# Copyright (C) 2015-2016 Canonical
#
# Authors:
#    Lee Trager <lee.trager@canonical.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, version 3 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

PYTHON_OAUTH_RPM_URL="https://kojipkgs.fedoraproject.org/packages/"\
"python-oauth/1.0.1/10.el7/noarch/python-oauth-1.0.1-10.el7.noarch.rpm"

error() { echo "$@" 1>&2; }
fail() { [ $# -eq 0 ] || error "$@"; exit 1; }

maasify() {
    local mnt_point="$1" out="$2" curtin_path="$3"

    if [ -d "$CURTIN_PATH" ]; then
        mkdir -p "$mnt_point/curtin"
        cp "$CURTIN_PATH/"* "$mnt_point/curtin/"
        chmod +x "$mnt_point/curtin/"*
    fi

    # CentOS 7 removed python-oauth which is required for cloud-init to
    # authenticate with the MAAS metadata service. Until cloud-init from CentOS
    # supports python-oauth2 we need to pull python-oauth from EPEL7-testing
    local fname="" url="$PYTHON_OAUTH_RPM_URL"
    if [ -f "$mnt_point/etc/os-release" ] &&
        grep -qc "centos:7" "$mnt_point/etc/os-release"; then
        echo "CentOS 7 detected! Adding python-oauth for MAAS cloud-init..."
        fname="/tmp/${PYTHON_OAUTH_RPM_URL##*/}"
        wget "$url" -O "$mnt_point/$fname" &&
            LANG=C chroot "$mnt_point" rpm -ivh "$fname" &&
            rm "$mnt_point/$fname" || {
                error "failed dl and installation of $url"
                return 1
            }
    fi

    echo "Taring up image contents..."
    tar -C "$mnt_point" --one-file-system -czf "$out" .
}

if [ "$1" = "maasify" ]; then
    [ "$(id -u)" = "0" ] || { error "not root, sorry"; exit 1; }
    "$@"
elif [ $# -eq 3 ] || [ $# -eq 4 ]; then
    url=$1
    img_name=$(basename "$url")
    sha256=$2
    if [ "$(dirname $3)" == "." ]; then
        out="${PWD}/${3}"
    else
        out=$3
    fi
    curtin_path=$4

    mkdir -p $(dirname "$out")

    if [ ! -f "$url" ]; then
        img_path="/tmp/$img_name"
        wget --continue "$url" -O "$img_path" &&
            mv "$img_path.tmp" "$img_path" ||
            fail "failed download $url"
    else
        img_path="$url"
    fi

    echo "Checking given sha256sum..."
    sha256_out=$(sha256sum "$img_path")
    found_sha256=${sha256_out%  *}
    if [ "$found_sha256" != "$sha256" ]; then
        echo "Error: sha256 of $img_path != $sha256"
        exit 1
    fi

    fout=$(LANG=C file "$img_path")
    case "${fout#$img_path: }" in
        "XZ compressed data"*)
            echo "Decompressing XZ image..."
            new_img_path="${img_path%%'.xz'}"
            [ -f "$new_img_path" ] && rm "$new_img_path"
            unxz $img_path
            img_path="${new_img_path}"
            ;;
    esac

    sudo \
        mount-image-callback --proc "$img_path" -- \
        "$0" maasify _MOUNTPOINT_ "$out" "$curtin_path"

    rm "$img_path"

    echo "Done!"
else
    echo "Usage: $0 <URL> <SHA256> <out file> [curtin file path]"
    exit 1
fi

# vi: ts=4 expandtab
