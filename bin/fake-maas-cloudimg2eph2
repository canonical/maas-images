#!/bin/bash
set -f

error() { echo "$@" 1>&2; }

short_opts="a:k:p:v"
long_opts="arch:,kernel:,krd-pack:,verbose"
getopt_out=$(getopt --name "${0##*/}" \
    --options "${short_opts}" --long "${long_opts}" -- "$@") &&
    eval set -- "${getopt_out}" ||
    { echo "bad arguments to $0"; exit 1; }

gzip=true
arch=""
kernel=""
kpacks=( )
while [ $# -ne 0 ]; do
	cur=$1
	next=$2
	case "$cur" in
		-a|--arch) arch="$next"; shift;;
		-k|--kernel) kernel=$next; shift;;
		-p|--krd-pack) kpacks[${#kpacks[@]}]=$next; shift;;
		   --no-gzip) gzip=false;;
		--) shift; break;;
	esac
	shift;
done

src=$1
root_gz=$2

ensure_d() { local d=""; d=$(dirname "$1"); mkdir -p "$d"; }

ensure_d "$root_gz"
$gzip && gzip_prog="gzip -c" || gzip_prog="cat"

error "src=$src arch=$arch kernel=$kernel output=$root_gz"
dd if=/dev/zero bs=1024 count=1024 2>/dev/null | $gzip_prog > "$root_gz"

OIFS="$IFS"
for kpack in "${kpacks[@]}"; do
    IFS=","; set -- $kpack ; IFS="$OIFS"
    pkg=$1; kout=$2; iout=$3;
    shift 3
    error "kpack: pkg=$pkg kout=$kout iout=$iout. flags=$*"
    ensure_d "$kout"
    ensure_d "$iout"
    echo "kernel: $pkg" > "$kout"
    echo "initrd: $pkg" > "$iout"
done
