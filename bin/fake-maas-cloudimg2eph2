#!/bin/bash
set -f

error() { echo "$@" 1>&2; }

short_opts="a:k:p:v"
long_opts="arch:,kernel:,krd-pack:,verbose"
getopt_out=$(getopt --name "${0##*/}" \
    --options "${short_opts}" --long "${long_opts}" -- "$@") &&
    eval set -- "${getopt_out}" ||
    { echo "bad arguments to $0"; exit 1; }

gzip=true
arch=""
kernel=""
kpacks=( )
while [ $# -ne 0 ]; do
	cur=$1
	next=$2
	case "$cur" in
		-a|--arch) arch="$next"; shift;;
		-k|--kernel) kernel=$next; shift;;
		-p|--krd-pack) kpacks[${#kpacks[@]}]=$next; shift;;
		   --no-gzip) gzip=false;;
		--) shift; break;;
	esac
	shift;
done

src=$1
root_gz=$2

ensure_d() { local d=""; d=$(dirname "$1"); mkdir -p "$d"; }

ensure_d "$root_gz"
$gzip && gzip_prog="gzip -c" || gzip_prog="cat"

error "src=$src arch=$arch kernel=$kernel output=$root_gz"
dd if=/dev/zero bs=1024 count=1024 2>/dev/null | $gzip_prog > "$root_gz"

OIFS="$IFS"
for kpack in "${kpacks[@]}"; do
    flags=""
    pkg=""; kout=""; iout=""; dtbs="";
    IFS=","; set -- $kpack ; IFS="$OIFS"
    error "kpack: $*"
    while [ $# -ne 0 ]; do
        case "$1" in
           --dtb=*|--dtb)
              [ "$1" = "--dtb" ] &&
                 { data="$2"; shift; } || data="${1#--dtb=}"
              echo "dtb-${data%%=*}" > "${data#*=}";;
           -*) flags="$flags $1";;
           *) 
              if [ -z "$pkg" ]; then
                 pkg="$1"
              elif [ -z "$kout" ]; then
                 kout="$1"
                 ensure_d "$kout"
                 echo "kernel: $pkg" > "$kout"
              elif [ -z "$iout" ]; then
                 iout="$1"
                 ensure_d "$iout"
                 echo "kernel: $pkg" > "$iout"
              else
                 error "confused by $*"
              fi
        esac
        shift;
    done
    ensure_d "$kout"
    ensure_d "$iout"
    echo "kernel: $pkg" > "$kout"
    echo "initrd: $pkg" > "$iout"
done
